---
language: python

env:
  matrix:
    - IMAGE=centos-6-x64
    - IMAGE=centos-7-x64
    - IMAGE=coreos-alpha
    - IMAGE=coreos-stable
    - IMAGE=debian-7-x64
    - IMAGE=debian-8-x64
    - IMAGE=debian-9-x64
    - IMAGE=fedora-24-x64
    - IMAGE=fedora-25-x64
    - IMAGE=fedora-26-x64
    - IMAGE=ubuntu-14-04-x64
    - IMAGE=ubuntu-17-04-x64
    - IMAGE=ubuntu-17-10-x64

install:
  - pip install ansible
  - gem install tugboat
  - sed -i s/DO_API_TOKEN/${DO_API_TOKEN}/ .tugboat
  - role=$(basename $(pwd) | sed 's/ansible-role-//g')
  - sudo mkdir -p /etc/ansible/roles/${role}
  - sudo cp -Rip * /etc/ansible/roles/${role}
  - test -f requirements.yml && ansible-galaxy install --role-file requirements.yml
  - ansible-playbook --inventory tests/inventory tests/test.yml --syntax-check
  - tugboat create ${IMAGE} -i ${IMAGE} -r ams3 -s 512mb -k 914738
  - tugboat info -n ${IMAGE} --attribute ip4 --porcelain > tests/inventory

script:
  - ansible-playbook --inventory tests/inventory tests/test.yml --become

after_script:
  - yes | tugboat destroy ${IMAGE}

notifications:
  webhooks: https://galaxy.ansible.com/api/v1/notifications/
  email: false
